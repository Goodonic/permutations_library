name: CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
        compiler: [gcc, clang]

    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang clang-tidy clang-format cppcheck valgrind

      - name: Configure CMake
        run: |
          cmake -B ${{github.workspace}}/build_${{matrix.compiler}}_${{matrix.build_type}} \
                -DCMAKE_BUILD_TYPE=${{matrix.build_type}} \
                -DCMAKE_C_COMPILER=${{matrix.compiler}} \
                -DENABLE_TESTING=ON \
                -DENABLE_BENCHMARKS=ON \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        run: |
          cmake --build ${{github.workspace}}/build_${{matrix.compiler}}_${{matrix.build_type}} \
                --config ${{matrix.build_type}} \
                --parallel $(nproc)

      - name: Run tests
        run: |
          cd ${{github.workspace}}/build_${{matrix.compiler}}_${{matrix.build_type}}
          ctest --output-on-failure --parallel $(nproc)

  code-quality:
    runs-on: ubuntu-latest
    # needs: build-and-test
    # if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v3

      - name: Install clang-tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang clang-tidy clang-format python3 python3-pip

      - name: Configure CMake for clang-tidy
        run: |
          cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build minimal target
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–ª—å —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å compile_commands.json
          cmake --build build --target help

      - name: Run clang-format check (exclude build directory)
        run: |
          # –ò—Å–∫–ª—é—á–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é build –∏ –¥—Ä—É–≥–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          find . -type f \( -name '*.c' -o -name '*.h' \) \
            ! -path "./build/*" \
            ! -path "./*/build/*" \
            ! -path "./*/*/build/*" \
            ! -name "CMakeCCompilerId.c" \
            ! -name "CMakeCXXCompilerId.cpp" \
            | xargs clang-format --dry-run --Werror 2>&1 || true

      - name: Run clang-tidy with detailed error reporting
        run: |
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
          cat > run_clang_tidy_detailed.py << 'EOF'
          import subprocess
          import sys
          import os
          
          total_errors = 0
          total_warnings = 0
          
          # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã, –∏—Å–∫–ª—é—á–∞—è build –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          source_files = []
          for root, dirs, files in os.walk("."):
              # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ build
              if "build" in root.split(os.sep):
                  continue
          
              for file in files:
                  if file.endswith(".c"):
                      filepath = os.path.join(root, file)
                      source_files.append(filepath)
          
          print(f"Found {len(source_files)} source files to check")
          print("=" * 60)
          
          for filepath in sorted(source_files):
              print(f"\nüîç Checking: {filepath}")
              print("-" * 40)
          
              # –ó–∞–ø—É—Å–∫–∞–µ–º clang-tidy —Å –º–µ–Ω–µ–µ —Å—Ç—Ä–æ–≥–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞
              cmd = [
                  "clang-tidy",
                  "-p", "build",
                  filepath,
                  "--checks=*,-clang-analyzer-*,-altera-*,-fuchsia-*,-android-*,-zircon-*",
                  # –£–±–∏—Ä–∞–µ–º --warnings-as-errors –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
              ]
          
              result = subprocess.run(
                  cmd,
                  capture_output=True,
                  text=True,
                  encoding='utf-8'
              )
          
              if result.stdout:
                  print(result.stdout)
                  # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                  error_count = result.stdout.count("error:")
                  warning_count = result.stdout.count("warning:")
                  total_errors += error_count
                  total_warnings += warning_count
          
                  if error_count > 0 or warning_count > 0:
                      print(f"üìä Found: {error_count} errors, {warning_count} warnings")
          
              if result.stderr:
                  print("STDERR:", result.stderr)
          
          print("\n" + "=" * 60)
          print("üìà FINAL SUMMARY")
          print("=" * 60)
          print(f"Total files checked: {len(source_files)}")
          print(f"Total errors found: {total_errors}")
          print(f"Total warnings found: {total_warnings}")
          
          if total_errors > 0:
              print("\n‚ùå FAILED: Found errors that need to be fixed")
              sys.exit(1)
          elif total_warnings > 0:
              print("\n‚ö†Ô∏è  WARNING: Found warnings (consider fixing them)")
              # –ù–µ –≤—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π –¥–ª—è warnings, —Ç–æ–ª—å–∫–æ –¥–ª—è errors
          else:
              print("\n‚úÖ SUCCESS: No errors or warnings found")
          EOF
          
          python3 run_clang_tidy_detailed.py

      - name: Create simplified test for debugging
        if: failure()
        run: |
          # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          echo "Debugging clang-tidy issues..."
          echo "Checking ./src/algorithms/optimized/binary_masks.c specifically:"
          
          # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -f "./src/algorithms/optimized/binary_masks.c" ]; then
              echo "File exists, running clang-tidy..."
              clang-tidy -p build ./src/algorithms/optimized/binary_masks.c \
                --checks=* 2>&1 || true
          else
              echo "File not found!"
          fi
          
          echo "Checking a few more problematic files..."
          for file in \
            "./src/algorithms/optimized/binary_masks.c" \
            "./benchmarks/performance_benchmark.c" \
            "./examples/constraint_example.c"; do
            if [ -f "$file" ]; then
                echo "=== $file ==="
                clang-tidy -p build "$file" --checks=readability-* 2>&1 | head -20
            fi
          done

      - name: Run cppcheck
        run: |
          echo "Running cppcheck on source directories..."
          cppcheck \
            --enable=warning,performance,portability,style \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --inline-suppr \
            --error-exitcode=1 \
            --force \
            --quiet \
            ./src ./examples ./benchmarks 2> cppcheck_output.txt || true
          
          if [ -s cppcheck_output.txt ]; then
              echo "Cppcheck found issues:"
              cat cppcheck_output.txt
              echo "‚ùå Cppcheck failed"
              exit 1
          else
              echo "‚úÖ Cppcheck passed"
          fi